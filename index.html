<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>MOD EKB | –°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://sun9-31.userapi.com/s/v1/ig2/P-9DJRiXns1RThh5B9Yo6rXD6OQIXebFVwPMsJdmF2AwpdQKZKMisyqK9tAmWwfd9whUVN_wtCJfqC2NdNx4wnNs.jpg?quality=95&as=32x32,48x48,72x72,108x108,160x160,240x240,360x360,480x480,540x540,640x640,720x720,1080x1080,1280x1280,1440x1440,1500x1500&from=bu&cs=1500x0">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --primary: #00e676; 
            --primary-glow: rgba(0, 230, 118, 0.4);
            --danger: #ff5252; 
            --bg: #0a0a0c;
            --card-bg: rgba(25, 25, 28, 0.8);
            --border: rgba(255, 255, 255, 0.08);
        }

        * { transition: all 0.3s ease; box-sizing: border-box; }

        body { 
            margin: 0; font-family: 'Inter', sans-serif; 
            background: var(--bg); color: white; min-height: 100vh;
            background-image: radial-gradient(circle at 50% -20%, #1a3a2a 0%, #0a0a0c 80%);
        }

        .container { 
            background: var(--card-bg); backdrop-filter: blur(20px); 
            width: 92%; max-width: 900px; margin: 20px auto; 
            padding: 30px; border-radius: 24px; border: 1px solid var(--border);
            position: relative; overflow: hidden;
        }

        .hidden { display: none !important; }

        /* –ë–∞–Ω–Ω–µ—Ä */
        .profile-banner {
            position: absolute; top: 0; left: 0; width: 100%; height: 120px;
            background-image: url('https://sun9-54.userapi.com/impf/Tgx54DTWLipaB0OQ75pdV4SaneS_2FuKw5DTkw/wtFg474Yp68.jpg?size=1920x768&quality=95&crop=0,0,1920,767&sign=dec3e31e8e9fcee1ee8e2b0c0b7b8b6b&c_uniq_tag=khTbxkvjsazKI2MbS3X42V9A5pauyCljYYt_gkpR838');
            background-size: cover; background-position: center; border-bottom: 1px solid var(--border);
        }

        .header { 
            background: rgba(10, 10, 12, 0.8); backdrop-filter: blur(10px);
            padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; 
        }

        .btn-nav { 
            background: rgba(255,255,255,0.05); border: 1px solid var(--border); 
            color: #ccc; padding: 8px 14px; font-size: 11px; cursor: pointer; 
            border-radius: 8px; font-weight: 600; text-transform: uppercase; margin-left: 5px;
        }
        .btn-nav:hover { background: var(--primary); color: black; }

        /* INFO –±–ª–æ–∫–∏ */
        .info-block { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 16px; padding: 20px; margin-bottom: 20px; }
        .info-title { color: var(--primary); font-weight: 800; text-transform: uppercase; margin-bottom: 10px; border-left: 3px solid var(--primary); padding-left: 10px; }
        .info-text { font-size: 14px; line-height: 1.6; color: #ddd; white-space: pre-wrap; }
        .info-img { width: 100%; border-radius: 10px; margin: 10px 0; border: 1px solid var(--border); }
        .edit-area { width: 100%; background: #000; color: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 5px; }

        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .avatar { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--primary); object-fit: cover; margin-top: 40px; position: relative; z-index: 1; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .stat-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 15px; border: 1px solid var(--border); }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; background: rgba(0,0,0,0.4); border: 1px solid var(--border); color: white; border-radius: 10px; font-family: inherit; }
        .btn-action { background: var(--primary); color: black; border: none; padding: 15px; border-radius: 12px; font-weight: 800; cursor: pointer; width: 100%; text-transform: uppercase; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; font-size: 11px; color: #666; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
        
        .report-item { background: rgba(255,255,255,0.02); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border); }
        .mini-img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; margin-right: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div id="modal" onclick="this.style.display='none'" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:1000; display:none; align-items:center; justify-content:center; padding:20px;">
    <img id="modal-img" style="max-width:100%; max-height:90vh; border-radius:10px;">
</div>

<div id="auth-section" class="container" style="max-width:400px; margin-top:10vh;">
    <h2 style="text-align:center;">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
    <input type="text" id="in-log-login" placeholder="–ù–∏–∫–Ω–µ–π–º">
    <input type="password" id="in-log-pass" placeholder="–ü–∞—Ä–æ–ª—å">
    <button class="btn-action" onclick="doLogin()">–í–æ–π—Ç–∏</button>
    <p style="text-align:center; font-size:12px; color:#555; margin-top:15px;" onclick="doRegister()">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</p>
</div>

<div id="app-section" class="hidden">
    <div class="header">
        <div id="user-tag" style="color:var(--primary); font-weight:bold;">...</div>
        <div class="nav-group">
            <button class="btn-nav" onclick="nav('info')">INFO</button>
            <button class="btn-nav" onclick="showProfile(currentUser)">–ü—Ä–æ—Ñ–∏–ª—å</button>
            <button class="btn-nav" onclick="nav('scores')">–¢–æ–ø</button>
            <button class="btn-nav" onclick="nav('report')">–û—Ç—á–µ—Ç</button>
            <button class="btn-nav hidden" id="nav-admin" onclick="nav('admin')">–ê–¥–º–∏–Ω</button>
            <button onclick="location.reload()" style="background:none; border:none; color:var(--danger); cursor:pointer;">‚úï</button>
        </div>
    </div>

    <div id="sec-info" class="container hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0;">üìö –ò–ù–§–û–†–ú–ê–¶–ò–Ø</h2>
            <button id="btn-edit-info" class="btn-nav hidden" onclick="toggleEditInfo()">–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨</button>
        </div>
        <div id="info-content-display"></div>
        <div id="info-edit-panel" class="hidden">
            <button class="btn-action" onclick="saveInfoChanges()" style="margin-bottom:20px;">–°–û–•–†–ê–ù–ò–¢–¨ –í–°–ï</button>
            <div id="info-editor-container"></div>
        </div>
    </div>

    <div id="sec-profile" class="container hidden" style="text-align:center;">
        <div class="profile-banner"></div>
        <img id="view-ava" class="avatar" src="">
        <h2 id="view-nick" style="margin:10px 0 5px 0;">---</h2>
        <div id="view-rank" style="color:var(--primary); font-size:11px; text-transform:uppercase;">---</div>
        <div class="stat-grid">
            <div class="stat-card"><b id="view-score">0</b><br><small>–ë–∞–ª–ª—ã</small></div>
            <div class="stat-card"><b id="stat-count">0</b><br><small>–û—Ç—á–µ—Ç—ã</small></div>
            <div class="stat-card"><b id="view-warns">0/3</b><br><small>–í—ã–≥–æ–≤–æ—Ä—ã</small></div>
        </div>
        <div id="profile-controls">
            <button class="btn-nav" onclick="document.getElementById('ava-upload').click()">–°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
            <input type="file" id="ava-upload" hidden accept="image/*" onchange="uploadAva(this)">
            <button class="btn-nav" onclick="changeNick()">–°–º–µ–Ω–∏—Ç—å –Ω–∏–∫</button>
        </div>
    </div>

    <div id="sec-scores" class="container hidden">
        <h2>üèÜ –†–ï–ô–¢–ò–ù–ì</h2>
        <table>
            <thead><tr><th>–ù–ò–ö</th><th>–†–ê–ù–ì</th><th>–ë–ê–õ–õ–´</th></tr></thead>
            <tbody id="list-scores"></tbody>
        </table>
    </div>

    <div id="sec-report" class="container hidden">
        <h2>–û–¢–ü–†–ê–í–ò–¢–¨ –û–¢–ß–ï–¢</h2>
        <input type="text" id="rep-rank" placeholder="–í–∞—à —Ç–µ–∫—É—â–∏–π —Ä–∞–Ω–≥">
        <textarea id="rep-work" rows="4" placeholder="–ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ?"></textarea>
        <input type="number" id="rep-val" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤ (—á–∏—Å–ª–æ)">
        <label style="font-size:11px; color:#666;">–î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê (–°–ö–†–ò–ù–®–û–¢–´):</label>
        <input type="file" id="rep-files" multiple accept="image/*">
        <button class="btn-action" onclick="sendReport()">–û–¢–ü–†–ê–í–ò–¢–¨ –ù–ê –ü–†–û–í–ï–†–ö–£</button>
    </div>

    <div id="sec-admin" class="container hidden">
        <h2>‚öôÔ∏è –£–ü–†–ê–í–õ–ï–ù–ò–ï</h2>
        <div id="list-users-admin"></div>
        <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
        <h3>–ü–û–°–õ–ï–î–ù–ò–ï –û–¢–ß–ï–¢–´</h3>
        <div id="list-reports-admin"></div>
    </div>
</div>

<script>
// FIREBASE CONFIG
const firebaseConfig = {
    apiKey: "AIzaSyAmqtdKfR8ZyMoYA2dBno5sGAtJbhmWJEc",
    authDomain: "modersekb.firebaseapp.com",
    projectId: "modersekb",
    databaseURL: "https://modersekb-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const OWNER = "Ecstasy9988";
let currentUser = "";
let userRole = "user";
let isEditingInfo = false;

// INFO DATA
const defaultInfo = [
    { title: "–í–ö –ë–ï–°–ï–î–´", text: "1. INFO - –ù–æ–≤–æ—Å—Ç–∏\n2. FLOOD - –û–±—â–µ–Ω–∏–µ\n3. –û–¢–ß–ï–¢–ù–û–°–¢–¨ - –†–∞–±–æ—Ç–∞", img: "" },
    { title: "–ò–ï–†–ê–†–•–ò–Ø", text: "9. –†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å\n... \n1. –ú–ª–∞–¥—à–∏–π –º–æ–¥–µ—Ä–∞—Ç–æ—Ä", img: "" },
    { title: "–°–ò–°–¢–ï–ú–ê –ü–û–í–´–®–ï–ù–ò–Ø", text: "–ú–ú -> –ú: 150 –±–∞–ª–ª–æ–≤ + 7 –¥–Ω–µ–π", img: "" },
    { title: "–ü–†–ê–í–ò–õ–ê", text: "–ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ—Ä–º—É.\n–ó–∞–ø—Ä–µ—â–µ–Ω–æ –Ω–µ–∞–¥–µ–∫–≤–∞—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ.", img: "" }
];

// NAVIGATION
function nav(id) {
    document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
    document.getElementById('sec-' + id).classList.remove('hidden');
    window.scrollTo(0,0);
}

// AUTH
function doLogin() {
    const l = document.getElementById('in-log-login').value.trim();
    const p = document.getElementById('in-log-pass').value.trim();
    if (l === OWNER && p === "Ecstasy20036") loginSuccess(l, 'owner');
    else db.ref('users/' + l).once('value', s => {
        const d = s.val();
        if (d && d.pass === p) loginSuccess(l, d.role);
        else alert("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!");
    });
}

function doRegister() {
    const l = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:");
    const p = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:");
    if(l && p) {
        db.ref('users/' + l).set({ pass: p, nick: l, role: 'user', score: 0, rank: '–ú–ª–∞–¥—à–∏–π –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä', warns: 0, reportsCount: 0 });
        alert("–£—Å–ø–µ—à–Ω–æ! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.");
    }
}

function loginSuccess(l, role) {
    currentUser = l;
    userRole = role;
    document.getElementById('auth-section').classList.add('hidden');
    document.getElementById('app-section').classList.remove('hidden');
    document.querySelector('#user-tag').innerText = l;
    
    if (role === 'admin' || role === 'owner') {
        document.getElementById('nav-admin').classList.remove('hidden');
        document.getElementById('btn-edit-info').classList.remove('hidden');
    }
    loadInfo();
    loadData();
    nav('info');
}

// INFO SYSTEM
function loadInfo() {
    db.ref('site_info').on('value', s => {
        const data = s.val() || defaultInfo;
        const display = document.getElementById('info-content-display');
        const editor = document.getElementById('info-editor-container');
        display.innerHTML = ""; editor.innerHTML = "";

        data.forEach((item, i) => {
            display.innerHTML += `<div class="info-block"><div class="info-title">${item.title}</div>${item.img ? `<img src="${item.img}" class="info-img">` : ''}<div class="info-text">${item.text}</div></div>`;
            editor.innerHTML += `<div class="info-block"><input type="text" id="edit-t-${i}" value="${item.title}" class="edit-area"><input type="text" id="edit-i-${i}" value="${item.img||''}" class="edit-area" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ"><textarea id="edit-x-${i}" rows="5" class="edit-area">${item.text}</textarea></div>`;
        });
    });
}

function toggleEditInfo() {
    isEditingInfo = !isEditingInfo;
    document.getElementById('info-content-display').classList.toggle('hidden', isEditingInfo);
    document.getElementById('info-edit-panel').classList.toggle('hidden', !isEditingInfo);
}

function saveInfoChanges() {
    const arr = [];
    for(let i=0; i<4; i++) {
        arr.push({ title: document.getElementById('edit-t-'+i).value, img: document.getElementById('edit-i-'+i).value, text: document.getElementById('edit-x-'+i).value });
    }
    db.ref('site_info').set(arr).then(() => { alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"); toggleEditInfo(); });
}

// PROFILE SYSTEM
function showProfile(nick) {
    nav('profile');
    db.ref('users/' + nick).on('value', s => {
        const d = s.val() || {};
        document.getElementById('view-nick').innerText = d.nick || nick;
        document.getElementById('view-rank').innerText = d.rank || "---";
        document.getElementById('view-score').innerText = d.score || 0;
        document.getElementById('view-warns').innerText = (d.warns || 0) + "/3";
        document.getElementById('stat-count').innerText = d.reportsCount || 0;
        document.getElementById('view-ava').src = d.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + nick;
    });
}

// REPORT SYSTEM
async function sendReport() {
    const work = document.getElementById('rep-work').value;
    const score = parseInt(document.getElementById('rep-val').value);
    const files = document.getElementById('rep-files').files;
    if(!work || isNaN(score)) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!");

    let imgs = [];
    for(let f of files) {
        const b64 = await new Promise(res => {
            const r = new FileReader();
            r.onload = () => res(r.result);
            r.readAsDataURL(f);
        });
        imgs.push(b64);
    }

    db.ref('reports').push({ author: currentUser, work, score, imgs, date: new Date().toLocaleString() });
    db.ref('users/' + currentUser).transaction(u => {
        if(u) { u.score = (u.score || 0) + score; u.reportsCount = (u.reportsCount || 0) + 1; }
        return u;
    });
    alert("–û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
    nav('profile');
}

// DATA LOAD
function loadData() {
    // Top List
    db.ref('users').on('value', s => {
        const users = s.val() || {};
        const listTop = document.getElementById('list-scores');
        const listAdmin = document.getElementById('list-users-admin');
        listTop.innerHTML = ""; listAdmin.innerHTML = "";

        Object.entries(users).sort((a,b) => b[1].score - a[1].score).forEach(([id, u]) => {
            listTop.innerHTML += `<tr><td>${u.nick}</td><td>${u.rank}</td><td style="color:var(--primary)">${u.score}</td></tr>`;
            
            if(userRole === 'admin' || userRole === 'owner') {
                listAdmin.innerHTML += `
                <div class="report-item" style="display:flex; justify-content:space-between; align-items:center;">
                    <span><b>${u.nick}</b> (${u.score} –±.)</span>
                    <div>
                        <button class="btn-nav" onclick="editUser('${id}')">–ü—Ä–∞–≤–∫–∞</button>
                        <button class="btn-nav" style="color:var(--danger)" onclick="deleteUser('${id}')">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>`;
            }
        });
    });

    // Admin Reports
    if(userRole === 'admin' || userRole === 'owner') {
        db.ref('reports').limitToLast(10).on('value', s => {
            const list = document.getElementById('list-reports-admin');
            list.innerHTML = "";
            Object.entries(s.val() || {}).reverse().forEach(([id, r]) => {
                let imgHtml = "";
                if(r.imgs) r.imgs.forEach(src => imgHtml += `<img src="${src}" class="mini-img" onclick="openFullImg('${src}')">`);
                list.innerHTML += `
                <div class="report-item">
                    <div style="display:flex; justify-content:space-between;"><b>${r.author}</b> <small>${r.date}</small></div>
                    <p style="font-size:13px;">${r.work}</p>
                    <div>${imgHtml}</div>
                    <button class="btn-nav" style="width:100%; margin-top:10px; color:var(--danger)" onclick="deleteReport('${id}', '${r.author}', ${r.score})">–£–î–ê–õ–ò–¢–¨ –û–¢–ß–ï–¢ (–û–¢–ö–ê–¢ –ë–ê–õ–õ–û–í)</button>
                </div>`;
            });
        });
    }
}

// ADMIN ACTIONS
function editUser(id) {
    const n = prompt("–ù–æ–≤—ã–π –Ω–∏–∫:");
    const r = prompt("–ù–æ–≤—ã–π —Ä–∞–Ω–≥:");
    const s = prompt("–ö–æ–ª-–≤–æ –±–∞–ª–ª–æ–≤:");
    const w = prompt("–í—ã–≥–æ–≤–æ—Ä—ã (0-3):");
    if(n) db.ref('users/'+id).update({ nick: n, rank: r, score: parseInt(s), warns: parseInt(w) });
}

function deleteUser(id) {
    if(id === OWNER) return alert("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞!");
    if(confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")) db.ref('users/'+id).remove();
}

function deleteReport(id, author, score) {
    if(confirm("–£–¥–∞–ª–∏—Ç—å –æ—Ç—á–µ—Ç –∏ —Å–ø–∏—Å–∞—Ç—å –±–∞–ª–ª—ã?")) {
        db.ref('reports/'+id).remove();
        db.ref('users/'+author).transaction(u => {
            if(u) { u.score = Math.max(0, u.score - score); u.reportsCount = Math.max(0, u.reportsCount - 1); }
            return u;
        });
    }
}

// UTILS
function openFullImg(src) { document.getElementById('modal-img').src = src; document.getElementById('modal').style.display = 'flex'; }
async function uploadAva(input) {
    const f = input.files[0];
    const r = new FileReader();
    r.onload = (e) => db.ref('users/' + currentUser).update({ avatar: e.target.result });
    r.readAsDataURL(f);
}
function changeNick() { const n = prompt("–ù–æ–≤—ã–π –Ω–∏–∫:"); if(n) db.ref('users/'+currentUser).update({ nick: n }); }
</script>
</body>
</html>
