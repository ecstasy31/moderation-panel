<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>MOD EKB | –û–¢–ß–ï–¢–ù–û–°–¢–¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://sun9-31.userapi.com/s/v1/ig2/P-9DJRiXns1RThh5B9Yo6rXD6OQIXebFVwPMsJdmF2AwpdQKZKMisyqK9tAmWwfd9whUVN_wtCJfqC2NdNx4wnNs.jpg?quality=95&as=32x32,48x48,72x72,108x108,160x160,240x240,360x360,480x480,540x540,640x640,720x720,1080x1080,1280x1280,1440x1440,1500x1500&from=bu&cs=1500x0">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        :root { 
            --primary: #5865F2; /* Discord Blurple */
            --success: #23a559;
            --danger: #f23f42;
            --bg-main: #1e1f22;
            --bg-card: #2b2d31;
            --bg-inner: #111214;
            --text-muted: #b5bac1;
            --border: rgba(255, 255, 255, 0.05);
        }

        * { transition: all 0.2s ease; box-sizing: border-box; outline: none; }

        body { 
            margin: 0; 
            font-family: 'gg sans', 'Segoe UI', Tahoma, sans-serif; 
            background: var(--bg-main); 
            color: white; 
            min-height: 100vh;
        }

        .hidden { display: none !important; }

        /* HEADER */
        .header { 
            background: var(--bg-card);
            padding: 12px 5%; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 2px solid var(--bg-inner);
            position: sticky; top: 0; z-index: 100;
        }

        .btn-nav { 
            background: #4e5058; 
            border: none; 
            color: white; 
            padding: 8px 16px; 
            font-size: 13px; 
            cursor: pointer; 
            border-radius: 4px;
            font-weight: 500;
            margin-left: 5px;
        }
        .btn-nav:hover { background: #6d6f78; }
        .btn-primary { background: var(--primary); }

        /* CONTAINER */
        .container { 
            background: var(--bg-card); 
            width: 95%; 
            max-width: 600px; 
            margin: 30px auto; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        /* BANNER */
        .profile-banner {
            width: 100%;
            height: 140px;
            background-image: url('https://sun9-54.userapi.com/impf/Tgx54DTWLipaB0OQ75pdV4SaneS_2FuKw5DTkw/wtFg474Yp68.jpg?size=1920x768&quality=95&crop=0,0,1920,767&sign=dec3e31e8e9fcee1ee8e2b0c0b7b8b6b&c_uniq_tag=khTbxkvjsazKI2MbS3X42V9A5pauyCljYYt_gkpR838');
            background-size: cover;
            background-position: center;
        }

        .profile-content { padding: 16px; position: relative; }

        .avatar-wrapper {
            position: relative;
            margin-top: -65px;
            margin-bottom: 15px;
            display: inline-block;
        }

        .avatar { 
            width: 100px; height: 100px; 
            border-radius: 50%; 
            border: 6px solid var(--bg-card);
            object-fit: cover; 
            background: var(--bg-main);
        }

        .status-dot {
            position: absolute; bottom: 8px; right: 8px;
            width: 20px; height: 20px;
            border-radius: 50%; border: 4px solid var(--bg-card);
        }

        .discord-box {
            background: var(--bg-inner);
            margin-top: 15px; padding: 16px; border-radius: 8px; text-align: left;
        }

        .section-label {
            font-size: 11px; font-weight: 800; color: var(--text-muted);
            text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px;
        }

        /* TABLES & FORMS */
        input, select, textarea { 
            width: 100%; padding: 12px; margin: 8px 0; 
            background: var(--bg-inner); border: 1px solid transparent; 
            color: white; border-radius: 4px; 
        }
        .btn-action { 
            background: var(--primary); color: white; border: none; 
            padding: 14px; border-radius: 4px; 
            font-weight: 600; cursor: pointer; width: 100%; 
        }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: var(--text-muted); font-size: 11px; text-transform: uppercase; }
        td { padding: 12px; border-top: 1px solid var(--border); }
    </style>
</head>
<body>

<div id="auth-section">
    <div class="container" style="max-width: 400px; padding: 30px; margin-top: 10vh;">
        <h2 style="text-align: center;">–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º</h2>
        <input type="text" id="auth-login" placeholder="–í–∞—à RP NickName">
        <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn-action" onclick="handleAuth('login')">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
        <p style="text-align:center; font-size:12px; color:var(--text-muted); margin-top:15px;">
            –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞? <span style="color:var(--primary); cursor:pointer;" onclick="handleAuth('reg')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
        </p>
    </div>
</div>

<div id="app-section" class="hidden">
    <div class="header">
        <div style="font-weight: 800; color: var(--primary);">MOD EKB</div>
        <div class="nav-group">
            <button class="btn-nav" onclick="showPage('profile')">–ü—Ä–æ—Ñ–∏–ª—å</button>
            <button class="btn-nav approval-hide" onclick="showPage('scores')">–¢–æ–ø</button>
            <button class="btn-nav approval-hide" onclick="showPage('report')">–û—Ç—á–µ—Ç</button>
            <button class="btn-nav hidden" id="nav-admin" onclick="showPage('admin')">–ú–µ–Ω–µ–¥–∂–µ—Ä</button>
            <button class="btn-nav" style="color: var(--danger);" onclick="logout()">‚úï</button>
        </div>
    </div>

    <div id="page-profile" class="container page">
        <div class="profile-banner"></div>
        <div class="profile-content">
            <div id="pending-msg" class="hidden" style="background:rgba(242,63,66,0.1); color:var(--danger); padding:12px; border-radius:8px; margin-bottom:15px; font-size:13px; border:1px solid var(--danger);">
                ‚ö†Ô∏è –ê–∫–∫–∞—É–Ω—Ç –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –ì–ª–∞–≤–Ω–æ–≥–æ –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞
            </div>

            <div class="avatar-wrapper">
                <img id="view-ava" class="avatar" src="">
                <div id="view-status" class="status-dot"></div>
            </div>

            <h2 id="view-nick" style="margin:0;">---</h2>
            <div id="view-rank" style="color:var(--text-muted); font-size:14px;">---</div>

            <div class="discord-box">
                <div class="section-label">–û–±–æ –º–Ω–µ</div>
                <div style="font-size:14px; color:var(--text-muted);">
                    –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ MOD EKB.<br>
                    –í —Å–µ—Ç–∏: <span id="view-lastseen" style="color:white;">---</span>
                </div>
            </div>

            <div class="discord-box">
                <div class="section-label">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>–ë–∞–ª–ª—ã</span> <span id="view-score" style="color:var(--success); font-weight:bold;">0</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>–û—Ç—á–µ—Ç—ã</span> <span id="stat-count">0</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>–í—ã–≥–æ–≤–æ—Ä—ã</span> <span id="view-warns" style="color:var(--danger);">0/3</span>
                </div>
            </div>

            <div class="discord-box">
                <div class="section-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                <div style="display:flex; gap:8px;">
                    <button class="btn-nav btn-primary" style="flex:1" onclick="document.getElementById('f-ava').click()">–°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
                    <input type="file" id="f-ava" hidden onchange="uploadAva(this)">
                    <button class="btn-nav" style="flex:1" onclick="changeNick()">–ù–∏–∫–Ω–µ–π–º</button>
                </div>
            </div>

            <div id="admin-tools" class="discord-box hidden" style="border: 1px solid var(--primary);">
                <div class="section-label" style="color:var(--primary);">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º</div>
                <input type="text" id="adm-rank" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å">
                <div style="display:flex; gap:8px;">
                    <button class="btn-nav btn-primary" style="flex:1" onclick="adminSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn-nav" style="background:var(--danger); flex:1" onclick="adminWarn(1)">+ –í—ã–≥–æ–≤–æ—Ä</button>
                    <button class="btn-nav" style="flex:1" onclick="adminWarn(-1)">- –í—ã–≥–æ–≤–æ—Ä</button>
                </div>
            </div>
        </div>
    </div>

    <div id="page-scores" class="container page hidden" style="padding:20px;">
        <h3 style="margin-top:0;">üèÜ –†–µ–π—Ç–∏–Ω–≥ —Å–æ—Å—Ç–∞–≤–∞</h3>
        <table>
            <thead><tr><th>NickName</th><th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th><th>–ë–∞–ª–ª—ã</th></tr></thead>
            <tbody id="scores-list"></tbody>
        </table>
    </div>

    <div id="page-report" class="container page hidden" style="padding:20px;">
        <h3 style="margin-top:0;">–ù–æ–≤—ã–π –æ—Ç—á–µ—Ç</h3>
        <p style="color:var(--text-muted); font-size:12px;">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ –∑–∞ –Ω–µ–¥–µ–ª—é</p>
        <label class="section-label">–í–∞—à–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç—å</label>
        <select id="rep-rank">
            <option>–ú–ª–∞–¥—à–∏–π –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
            <option>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
            <option>–°—Ç–∞—Ä—à–∏–π –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
        </select>
        <textarea id="rep-work" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤—ã —Å–¥–µ–ª–∞–ª–∏..."></textarea>
        <input type="number" id="rep-val" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–¥–∞–Ω–Ω—ã—Ö –Ω–∞–∫–∞–∑–∞–Ω–∏–π (—á–∏—Å–ª–æ)">
        <button class="btn-action" onclick="sendReport()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</button>
    </div>

    <div id="page-admin" class="container page hidden" style="padding:20px;">
        <h3 style="margin-top:0;">‚öôÔ∏è –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–æ—Å—Ç–∞–≤–∞</h3>
        <div id="admin-list"></div>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyAmqtdKfR8ZyMoYA2dBno5sGAtJbhmWJEc",
    authDomain: "modersekb.firebaseapp.com",
    projectId: "modersekb",
    databaseURL: "https://modersekb-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const OWNER = "Ecstasy9988";
let currentUser = "";
let userRole = "pending";
let viewedUser = "";

function handleAuth(type) {
    const l = document.getElementById('auth-login').value.trim();
    const p = document.getElementById('auth-pass').value.trim();
    if(!l || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");

    if(type === 'login') {
        if(l === OWNER && p === "Ecstasy20036") return loginDone(l, 'owner');
        db.ref('users/'+l).once('value', s => {
            if(s.exists() && s.val().pass === p) loginDone(l, s.val().role);
            else alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å");
        });
    } else {
        db.ref('users/'+l).set({pass:p, nick:l, role:'pending', score:0, rank:'–ú–ª–∞–¥—à–∏–π –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä', warns:0, lastSeen:Date.now()})
        .then(() => loginDone(l, 'pending'));
    }
}

function loginDone(l, role) {
    currentUser = l;
    userRole = role;
    localStorage.setItem('mod_user', l);
    document.getElementById('auth-section').classList.add('hidden');
    document.getElementById('app-section').classList.remove('hidden');
    
    const isApproved = role !== 'pending';
    document.querySelectorAll('.approval-hide').forEach(el => el.classList.toggle('hidden', !isApproved));
    document.getElementById('pending-msg').classList.toggle('hidden', isApproved);
    
    if(role === 'admin' || role === 'owner') document.getElementById('nav-admin').classList.remove('hidden');
    
    showPage('profile');
    loadData();
    setInterval(() => db.ref('users/'+currentUser+'/lastSeen').set(Date.now()), 60000);
}

function showPage(p) {
    document.querySelectorAll('.page').forEach(el => el.classList.add('hidden'));
    document.getElementById('page-'+p).classList.remove('hidden');
    if(p === 'profile') loadProfile(currentUser);
}

function loadProfile(nick) {
    viewedUser = nick;
    db.ref('users/'+nick).on('value', s => {
        const d = s.val(); if(!d) return;
        document.getElementById('view-nick').innerText = d.nick || nick;
        document.getElementById('view-rank').innerText = d.rank;
        document.getElementById('view-score').innerText = d.score || 0;
        document.getElementById('view-warns').innerText = (d.warns||0)+"/3";
        document.getElementById('stat-count').innerText = d.reportsCount || 0;
        document.getElementById('view-ava').src = d.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed='+nick;
        
        const isOnline = d.lastSeen && (Date.now() - d.lastSeen < 300000);
        document.getElementById('view-status').style.background = isOnline ? 'var(--success)' : '#80848e';
        document.getElementById('view-lastseen').innerText = d.lastSeen ? new Date(d.lastSeen).toLocaleString() : "---";

        const canManage = (userRole === 'admin' || userRole === 'owner') && nick !== OWNER;
        document.getElementById('admin-tools').classList.toggle('hidden', !canManage);
    });
}

function loadData() {
    db.ref('users').on('value', s => {
        const users = s.val();
        const sList = document.getElementById('scores-list');
        const aList = document.getElementById('admin-list');
        sList.innerHTML = ""; aList.innerHTML = "";

        Object.entries(users).sort((a,b) => b[1].score - a[1].score).forEach(([id, u]) => {
            if(u.role !== 'pending') {
                sList.innerHTML += `<tr onclick="showPage('profile'); loadProfile('${id}')"><td>${u.nick||id}</td><td style="font-size:11px; color:var(--text-muted)">${u.rank}</td><td style="color:var(--success); font-weight:bold;">${u.score}</td></tr>`;
            }
            if(userRole === 'admin' || userRole === 'owner') {
                aList.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid var(--border)">
                    <span>${u.nick||id} <small>(${u.role})</small></span>
                    <button class="btn-nav" onclick="showPage('profile'); loadProfile('${id}')">–£–ø—Ä–∞–≤–ª—è—Ç—å</button>
                </div>`;
            }
        });
    });
}

function sendReport() {
    const val = parseInt(document.getElementById('rep-val').value);
    const work = document.getElementById('rep-work').value;
    if(!val || !work) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");
    db.ref('users/'+currentUser).transaction(u => {
        if(u) { u.score = (u.score||0)+val; u.reportsCount = (u.reportsCount||0)+1; }
        return u;
    });
    alert("–û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
    showPage('profile');
}

function uploadAva(input) {
    if(input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => db.ref('users/'+currentUser).update({avatar: e.target.result});
        reader.readAsDataURL(input.files[0]);
    }
}

function changeNick() {
    const n = prompt("–ù–æ–≤—ã–π –Ω–∏–∫:");
    if(n) db.ref('users/'+currentUser).update({nick: n});
}

function adminSave() {
    const r = document.getElementById('adm-rank').value;
    if(r) db.ref('users/'+viewedUser).update({rank: r, role: 'user'});
}

function adminWarn(v) {
    db.ref('users/'+viewedUser).transaction(u => {
        if(u) u.warns = Math.max(0, (u.warns||0)+v);
        return u;
    });
}

function logout() { localStorage.clear(); location.reload(); }

window.onload = () => {
    const saved = localStorage.getItem('mod_user');
    if(saved) db.ref('users/'+saved).once('value', s => { if(s.exists()) loginDone(saved, s.val().role); });
};
</script>
</body>
</html>
