<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>MOD EKB | –û–¢–ß–ï–¢–ù–û–°–¢–¨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://sun9-31.userapi.com/s/v1/ig2/P-9DJRiXns1RThh5B9Yo6rXD6OQIXebFVwPMsJdmF2AwpdQKZKMisyqK9tAmWwfd9whUVN_wtCJfqC2NdNx4wnNs.jpg?quality=95&as=32x32,48x48,72x72,108x108,160x160,240x240,360x360,480x480,540x540,640x640,720x720,1080x1080,1280x1280,1440x1440,1500x1500&from=bu&cs=1500x0">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root { 
            --primary: #00e676; 
            --primary-glow: rgba(0, 230, 118, 0.4);
            --danger: #ff5252; 
            --bg: #0a0a0c;
            --card-bg: rgba(25, 25, 28, 0.8);
            --border: rgba(255, 255, 255, 0.08);
        }

        * { transition: all 0.3s ease; box-sizing: border-box; }

        body { 
            margin: 0; 
            font-family: 'Inter', 'Segoe UI', sans-serif; 
            background: var(--bg); 
            background-image: radial-gradient(circle at 50% -20%, #1a3a2a 0%, #0a0a0c 80%);
            color: white; 
            min-height: 100vh;
            position: relative;
        }

        /* –î–µ–∫–æ—Ä —Ñ–æ–Ω–∞ */
        body::before, body::after {
            content: "";
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 350px;
            height: 350px;
            background-size: contain;
            background-repeat: no-repeat;
            z-index: -1;
            pointer-events: none;
            opacity: 0.6;
        }
        body::after { left: 20px; right: auto; transform: translateY(-50%); }
        body::before { right: 20px; left: auto; transform: translateY(-50%) scaleX(-1); }

        @media (max-width: 1400px) { body::before, body::after { display: none; } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        .container { 
            background: var(--card-bg); 
            backdrop-filter: blur(20px); 
            width: 92%; 
            max-width: 800px; 
            margin: 20px auto; 
            padding: 30px; 
            border-radius: 24px; 
            border: 1px solid var(--border);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            animation: fadeIn 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .hidden { display: none !important; }

        .profile-banner {
            position: absolute; top: 0; left: 0; width: 100%; height: 120px;
            background-image: url('https://sun9-54.userapi.com/impf/Tgx54DTWLipaB0OQ75pdV4SaneS_2FuKw5DTkw/wtFg474Yp68.jpg?size=1920x768&quality=95&crop=0,0,1920,767&sign=dec3e31e8e9fcee1ee8e2b0c0b7b8b6b&c_uniq_tag=khTbxkvjsazKI2MbS3X42V9A5pauyCljYYt_gkpR838');
            background-size: cover; background-position: center; z-index: 0;
            border-bottom: 1px solid var(--border);
        }

        .profile-content { position: relative; z-index: 1; margin-top: 40px; }

        .header { 
            background: rgba(10, 10, 12, 0.8); backdrop-filter: blur(10px);
            padding: 15px 5%; display: flex; justify-content: space-between; 
            align-items: center; border-bottom: 1px solid var(--border); 
            position: sticky; top: 0; z-index: 100; 
        }

        .btn-nav { 
            background: rgba(255,255,255,0.05); border: 1px solid var(--border); 
            color: #ccc; padding: 8px 16px; font-size: 11px; cursor: pointer; 
            border-radius: 8px; margin-left: 5px; font-weight: 600; text-transform: uppercase;
        }
        .btn-nav:hover { background: var(--primary); color: black; border-color: var(--primary); box-shadow: 0 0 15px var(--primary-glow); }

        .avatar { 
            width: 130px; height: 130px; 
            border-radius: 35% 65% 65% 35% / 30% 30% 70% 70%; 
            border: 4px solid var(--primary); object-fit: cover; 
            box-shadow: 0 0 30px var(--primary-glow); background: var(--bg);
        }
        
        .mini-avatar { width: 32px; height: 32px; border-radius: 8px; object-fit: cover; border: 1px solid var(--primary); margin-right: 10px; vertical-align: middle; }

        .progress-bar { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; margin: 15px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); box-shadow: 0 0 10px var(--primary); width: 0%; }

        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 25px 0; }
        .stat-card { background: rgba(255,255,255,0.03); padding: 20px 10px; border-radius: 16px; border: 1px solid var(--border); text-align: center; }
        .stat-val { font-size: 24px; font-weight: 800; color: white; display: block; }
        .stat-label { font-size: 9px; text-transform: uppercase; color: var(--primary); letter-spacing: 1.5px; margin-top: 5px; opacity: 0.8; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { padding: 15px; text-align: left; font-size: 10px; text-transform: uppercase; color: #666; letter-spacing: 1px; border: 1px solid var(--border); }
        td { padding: 15px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); }

        input, select, textarea { 
            width: 100%; padding: 14px; margin: 8px 0; 
            background: rgba(0,0,0,0.3); border: 1px solid var(--border); 
            color: white; border-radius: 12px; font-size: 14px;
        }
        input:focus { border-color: var(--primary); outline: none; background: rgba(0,0,0,0.5); }

        .btn-action { 
            background: var(--primary); color: black; border: none; 
            padding: 16px; border-radius: 12px; font-weight: 800; cursor: pointer; 
            width: 100%; text-transform: uppercase; letter-spacing: 1px; margin-top: 10px;
        }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 10px 20px var(--primary-glow); }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-small-icon {
            background: none; border: none; color: #888; cursor: pointer; padding: 5px; font-size: 14px;
        }
        .btn-small-icon:hover { color: var(--primary); }

        .online-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .dot-green { background: var(--primary); box-shadow: 0 0 10px var(--primary); }
        .dot-red { background: var(--danger); }

        .report-card { background: rgba(255,255,255,0.02); border: 1px solid var(--border); padding: 20px; border-radius: 18px; margin-bottom: 20px; }

        #admin-full-controls input { padding: 8px 12px; font-size: 12px; margin: 4px 0; }
        #admin-full-controls .btn-action { padding: 10px; font-size: 11px; }
        #admin-full-controls .btn-nav { padding: 6px 10px; font-size: 10px; }
        #view-lastseen { color: #888; font-size: 11px; margin-top: 8px; }

        .full-table { width: 100%; overflow-x: auto; margin-top: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .full-table table { margin-top: 0; border-spacing: 0; font-size: 12px; border-collapse: collapse; }
        .full-table th { background: rgba(255,255,255,0.05); color: var(--primary); padding: 10px; border: 1px solid var(--border); white-space: nowrap; }
        .full-table td { padding: 10px; border: 1px solid var(--border); background: none; }
        .editable { cursor: pointer; }
        .editable:hover { color: var(--primary); background: rgba(255,255,255,0.03); }
        
        .info-post { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 15px; border-radius: 12px; margin-bottom: 15px; position: relative; }
        .info-img { max-width: 100%; border-radius: 10px; margin-top: 10px; border: 1px solid var(--border); }
        .info-controls { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }

        .shop-layout { display: flex; gap: 20px; align-items: flex-start; }
        .shop-main { flex: 1; }
        .roulette-side { width: 280px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 18px; padding: 20px; position: sticky; top: 80px; text-align: center; }
        @media (max-width: 900px) { .shop-layout { flex-direction: column; } .roulette-side { width: 100%; position: static; } }

        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 20px; }
        .shop-item { background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 20px; border-radius: 16px; text-align: center; position: relative; }
        .shop-item:hover { border-color: var(--primary); transform: translateY(-3px); }
        .shop-price { color: var(--primary); font-weight: 800; font-size: 18px; margin: 10px 0; }
        .btn-buy { background: rgba(0, 230, 118, 0.1); color: var(--primary); border: 1px solid var(--primary); padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; width: 100%; }
        .btn-buy:hover { background: var(--primary); color: black; }

        .roulette-window { width: 100%; height: 80px; background: #000; border: 2px solid var(--border); border-radius: 12px; margin: 20px 0; position: relative; overflow: hidden; }
        .roulette-pointer { position: absolute; top: 0; left: 50%; width: 2px; height: 100%; background: var(--primary); z-index: 5; box-shadow: 0 0 10px var(--primary); transform: translateX(-50%); }
        .roulette-reel { display: flex; position: absolute; left: 0; top: 0; height: 100%; transition: transform 4s cubic-bezier(0.1, 0, 0.1, 1); }
        .reel-item { min-width: 100px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; border-right: 1px solid var(--border); padding: 5px; text-align: center; background: rgba(255,255,255,0.02); }

        #email-blocker {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px);
            z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        #email-blocker-content {
            background: var(--card-bg); padding: 30px; border-radius: 20px; border: 1px solid var(--primary);
            width: 90%; max-width: 400px; text-align: center;
        }
    </style>
</head>
<body>

<div id="email-blocker">
    <div id="email-blocker-content">
        <h2 style="color:var(--primary); margin-top:0;">‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ—á—Ç—ã</h2>
        <p style="font-size:13px; color:#ccc; margin-bottom:20px;">
            –í —Ü–µ–ª—è—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–µ –∑–∞–∫—Ä—ã—Ç –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è E-mail.
        </p>
        
        <div id="step-bind-email">
            <input type="email" id="bind-email-input" placeholder="–í–∞—à–∞ –ø–æ—á—Ç–∞ (example@mail.ru)">
            <button class="btn-action" id="btn-send-code" onclick="sendVerificationCode()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
        </div>

        <div id="step-verify-code" class="hidden">
            <p style="font-size:11px; color:var(--primary);">–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–æ—á—Ç—É!</p>
            <input type="text" id="verify-code-input" placeholder="–ö–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞ (6 —Ü–∏—Ñ—Ä)" maxlength="6" style="text-align:center; letter-spacing:5px; font-size:18px;">
            <button class="btn-action" onclick="confirmEmailCode()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            <button class="btn-nav" onclick="document.getElementById('step-verify-code').classList.add('hidden'); document.getElementById('step-bind-email').classList.remove('hidden');" style="margin-top:10px;">–ù–∞–∑–∞–¥</button>
        </div>
        <p style="font-size:10px; color:#666; margin-top:15px;">–ù–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–æ–¥? –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ø–∞–º.</p>
    </div>
</div>

<div id="modal" onclick="this.style.display='none'" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:1000; display:none; align-items:center; justify-content:center;">
    <img src="" id="modal-img" style="max-width:90%; max-height:90vh; border-radius:12px; box-shadow: 0 0 50px rgba(0,0,0,0.5);">
</div>

<div id="auth-section" class="container" style="max-width:400px; margin-top:10vh;">
    <div id="box-log">
        <h2 style="margin-bottom:30px; letter-spacing:-1px;">–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º</h2>
        <input type="text" id="in-log-login" placeholder="–í–∞—à RP NickName">
        <input type="password" id="in-log-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn-action" onclick="doLogin()">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
        
        <div style="display:flex; justify-content:space-between; margin-top:20px; font-size:12px;">
            <span style="color:#888;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞? <span style="color:var(--primary); cursor:pointer;" onclick="toggleAuth('reg')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></span>
            <span style="color:var(--danger); cursor:pointer;" onclick="toggleAuth('reset')">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</span>
        </div>
    </div>
    
    <div id="box-reg" class="hidden">
        <h2 style="margin-bottom:30px; letter-spacing:-1px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <input type="text" id="in-reg-login" placeholder="RP NickName">
        <input type="email" id="in-reg-email" placeholder="E-mail (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
        <input type="password" id="in-reg-pass" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
        <button class="btn-action" onclick="doRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        <p style="font-size:12px; margin-top:20px; color:#888;">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span style="color:var(--primary); cursor:pointer;" onclick="toggleAuth('log')">–í–æ–π—Ç–∏</span></p>
    </div>

    <div id="box-reset" class="hidden">
        <h2 style="margin-bottom:20px; letter-spacing:-1px;">–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</h2>
        <p style="font-size:12px; color:#aaa; margin-bottom:15px;">–í–≤–µ–¥–∏—Ç–µ –ø–æ—á—Ç—É, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—É—é –∫ –∞–∫–∫–∞—É–Ω—Ç—É.</p>
        
        <div id="reset-step-1">
            <input type="email" id="reset-email" placeholder="–í–∞—à E-mail">
            <button class="btn-action" id="btn-reset-send" onclick="initiateReset()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>

        <div id="reset-step-2" class="hidden">
            <input type="text" id="reset-code" placeholder="–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è">
            <input type="password" id="reset-new-pass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
            <button class="btn-action" onclick="confirmReset()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</button>
        </div>

        <p style="font-size:12px; margin-top:20px; color:#888; cursor:pointer;" onclick="toggleAuth('log')">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫–æ –≤—Ö–æ–¥—É</p>
    </div>
</div>

<div id="app-section" class="hidden">
    <div class="header">
        <div id="user-tag" style="font-size: 12px; color: var(--primary); font-weight: 800; display: flex; align-items: center;">
            <div class="online-dot dot-green"></div> <span>...</span>
        </div>
        <div class="nav-group">
            <button class="btn-nav" onclick="showProfile(currentUser)">–ü—Ä–æ—Ñ–∏–ª—å</button>
            <button class="btn-nav approval-hide" onclick="nav('info')">–ò–ù–§–û</button>
            <button class="btn-nav approval-hide" onclick="nav('shop')">–ú–∞–≥–∞–∑–∏–Ω</button>
            <button class="btn-nav approval-hide" onclick="nav('scores')">–¢–æ–ø</button>
            <button class="btn-nav approval-hide" onclick="nav('fulltable')">–¢–∞–±–ª–∏—Ü–∞</button>
            <button class="btn-nav approval-hide" id="nav-rep-btn" onclick="nav('report')">–û—Ç—á–µ—Ç</button>
            <button class="btn-nav hidden" id="nav-base" onclick="nav('base')">–ë–∞–∑–∞</button>
            <button class="btn-nav hidden" id="nav-admin" onclick="nav('admin')">–ú–µ–Ω–µ–¥–∂–µ—Ä</button>
            <button class="btn-nav hidden" id="nav-mail" onclick="nav('mail')">–ü–æ—á—Ç–∞–º—Ç</button>
            <button class="btn-nav hidden admin-only" onclick="nav('logs')">–õ–û–ì–ò</button>
            <button class="btn-logout" onclick="logout()" style="background:none; border:none; color:var(--danger); font-size:18px; cursor:pointer; vertical-align:middle; margin-left:10px;">‚úï</button>
        </div>
    </div>

    <div id="sec-profile" class="container" style="text-align:center;">
        <div class="profile-banner"></div>

        <div class="profile-content">
            <div id="pending-msg" class="hidden" style="background:rgba(255,82,82,0.1); color:var(--danger); padding:15px; border-radius:12px; margin-bottom:20px; font-size:13px; border:1px solid rgba(255,82,82,0.2);">
                ‚ö†Ô∏è –ê–∫–∫–∞—É–Ω—Ç –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –ì–ª–∞–≤–Ω–æ–≥–æ –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞
            </div>
            
            <div class="profile-header" style="position:relative; display:inline-block;">
                <img id="view-ava" class="avatar" src="">
                <div id="inactive-tag" class="hidden" style="position:absolute; top:0; right:-20px; background:#ffd600; color:black; padding:4px 10px; border-radius:8px; font-weight:bold; font-size:10px;">INACTIVE</div>
            </div>

            <h2 id="view-nick" style="margin:10px 0 5px 0; font-size:28px; letter-spacing:-1px;">---</h2>
            <div id="view-rank" style="color:var(--primary); font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:2px;">---</div>
            <div id="view-lastseen">---</div>

            <div id="profile-stats-container">
                <div class="progress-bar"><div id="rank-progress" class="progress-fill"></div></div>
                
                <div class="stat-grid">
                    <div class="stat-card">
                        <span class="stat-val" id="view-score">0</span>
                        <span class="stat-label">–ë–∞–ª–ª—ã</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-val" id="stat-count">0</span>
                        <span class="stat-label">–û—Ç—á–µ—Ç—ã</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-val" id="view-warns-num">0/3</span>
                        <span class="stat-label">–í—ã–≥–æ–≤–æ—Ä—ã</span>
                    </div>
                </div>
            </div>

            <div id="my-profile-controls" class="hidden" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom: 10px;">
                <button class="btn-nav" onclick="document.getElementById('ava-upload').click()">–°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
                <input type="file" id="ava-upload" hidden accept="image/*" onchange="uploadAva(this)">
                
                <button class="btn-nav" onclick="changeNick()">–°–º–µ–Ω–∏—Ç—å –Ω–∏–∫</button>
                
                <button class="btn-nav" style="width:100%;" onclick="skipMeeting()">–ü—Ä–æ–ø—É—Å–∫ —Å–æ–±—Ä–∞–Ω–∏—è (5)</button>
                <button class="btn-nav" style="width:100%;" onclick="removeWarn()">–°–Ω—è—Ç—å –≤—ã–≥–æ–≤–æ—Ä (10)</button>

                <button id="btn-take-inactive" class="btn-nav" style="width: 100%; border-color:#ffd600; color:#ffd600; grid-column: span 2;" onclick="takeInactive()">–í–∑—è—Ç—å –Ω–µ–∞–∫—Ç–∏–≤ (10 –±–∞–ª–ª–æ–≤)</button>
                <button id="btn-exit-inactive" class="btn-nav hidden" style="width: 100%; background:#ffd600; color:black; grid-column: span 2;" onclick="exitInactive()">–í—ã–π—Ç–∏ –∏–∑ –Ω–µ–∞–∫—Ç–∏–≤–∞</button>
            </div>

            <div id="admin-full-controls" class="hidden" style="margin-top:20px; border-top:1px solid var(--border); padding-top:15px; text-align:left;">
                <p style="font-size:10px; color:var(--primary); text-transform:uppercase; font-weight:bold; margin-bottom:10px;">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º</p>
                
                <label style="font-size:9px; color:#666;">RP NICKNAME</label>
                <input type="text" id="edit-nick-input" placeholder="–ù–∏–∫">
                
                <label style="font-size:9px; color:#666;">–î–û–õ–ñ–ù–û–°–¢–¨</label>
                <input type="text" id="edit-rank-input" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å">

                <div style="display:flex; gap:8px; margin-top:8px;">
                    <button class="btn-action" style="flex:1;" id="btn-save-admin">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn-action" style="background:var(--danger); color:white; flex:1;" id="btn-delete-user">–ö–∏–∫–Ω—É—Ç—å (–£–¥–∞–ª–∏—Ç—å)</button>
                </div>

                <div style="display:flex; gap:8px; margin-top:8px;">
                    <button class="btn-nav" style="flex:1; background:var(--danger); color:white;" id="btn-add-warn">+ –í—ã–≥–æ–≤–æ—Ä</button>
                    <button class="btn-nav" style="flex:1;" id="btn-rem-warn">- –í—ã–≥–æ–≤–æ—Ä</button>
                </div>
                <button class="btn-nav" style="width:100%; margin-top:8px;" id="btn-toggle-top">–£–±—Ä–∞—Ç—å/–í–µ—Ä–Ω—É—Ç—å –≤ –¢–æ–ø</button>
            </div>
        </div>
    </div>

    <div id="sec-info" class="container hidden">
        <h3 style="text-align:left; margin-bottom:20px;">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        
        <div id="admin-info-controls" class="hidden" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-bottom:20px;">
            <p style="font-size:10px; color:var(--primary); text-transform:uppercase; font-weight:bold;">–†–µ–¥–∞–∫—Ç–æ—Ä</p>
            <input type="text" id="info-new-title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–∞–∑–¥–µ–ª–∞">
            <textarea id="info-new-text" rows="4" placeholder="–¢–µ–∫—Å—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏..."></textarea>
            <input type="file" id="info-new-img" accept="image/*" style="margin-top:10px;">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-action" id="btn-publish-info" onclick="addInfoPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                <button class="btn-nav hidden" id="btn-cancel-info" onclick="cancelEditInfo()" style="background: var(--danger); color:white;">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>

        <div id="info-list"></div>
    </div>

    <div id="sec-shop" class="container hidden" style="max-width: 1100px;">
        <h3 style="text-align:left; margin-bottom:20px;">üíé –ú–∞–≥–∞–∑–∏–Ω –∏ –£–¥–∞—á–∞</h3>
        
        <div class="shop-layout">
            <div class="shop-main">
                <div id="admin-shop-controls" class="hidden" style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; margin-bottom:20px;">
                    <p style="font-size:10px; color:var(--primary); text-transform:uppercase; font-weight:bold;">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</p>
                    <input type="text" id="shop-new-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
                    <input type="number" id="shop-new-price" placeholder="–¶–µ–Ω–∞ –≤ –±–∞–ª–ª–∞—Ö">
                    <button class="btn-action" onclick="addShopItem()">–î–æ–±–∞–≤–∏—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω</button>
                </div>
                <div id="shop-items-list" class="shop-grid"></div>
            </div>

            <div class="roulette-side">
                <h4 style="margin:0; color:var(--primary);">üé∞ –ö–ï–ô–° –£–î–ê–ß–ò</h4>
                <p style="font-size:10px; color:#888;">–®–∞–Ω—Å –≤—ã–±–∏—Ç—å –¥–æ—Ä–æ–≥–æ–π —Ç–æ–≤–∞—Ä –∏–ª–∏ –±–∞–ª–ª—ã</p>
                
                <div class="roulette-window">
                    <div class="roulette-pointer"></div>
                    <div id="roulette-reel" class="roulette-reel"></div>
                </div>

                <div style="font-size:18px; font-weight:bold; margin-bottom:10px;">15 <small style="font-size:10px; color:var(--primary);">–±–∞–ª–ª–æ–≤</small></div>
                <button class="btn-action" id="btn-spin" onclick="spinRoulette()" style="margin:0;">–ö—Ä—É—Ç–∏—Ç—å</button>
                <div id="roulette-result" style="margin-top:15px; font-size:12px; min-height:1.5em; font-weight:bold;"></div>
            </div>
        </div>
    </div>

    <div id="sec-fulltable" class="container hidden" style="max-width: 1000px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">üìä –û–±—â–∏–π —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</h3>
            <button id="add-table-row" class="btn-nav hidden" onclick="addTableRow()" style="background: var(--primary); color: black;">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
        </div>
        <div class="full-table">
            <table>
                <thead>
                    <tr>
                        <th class="admin-only hidden" style="width:50px;">#</th>
                        <th>Nick_Name</th>
                        <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                        <th>–î–∞—Ç–∞ –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</th>
                        <th>–ü—Ä–æ—à–ª–æ</th>
                        <th>–ü—Ä–µ–¥-—è</th>
                        <th>–í—ã–≥–æ–≤–æ—Ä—ã</th>
                        <th>–ü–æ—Å–ª. –ø–æ–≤—ã—à-–µ</th>
                        <th>–î–Ω–µ–π —Å –ø–æ–≤-—è</th>
                        <th class="admin-only hidden">–î–µ–π—Å—Ç–≤–∏–µ</th>
                    </tr>
                </thead>
                <tbody id="tbody-full"></tbody>
            </table>
        </div>
    </div>

    <div id="sec-scores" class="container hidden">
        <h3 style="text-align:left; margin-bottom:20px;">üèÜ –†–µ–π—Ç–∏–Ω–≥ —Å–æ—Å—Ç–∞–≤–∞</h3>
        <table>
            <thead><tr><th>NicnName</th><th>–î–æ–ª–æ–∂–Ω–æ—Å—Ç—å</th><th>–ë–∞–ª–ª—ã</th></tr></thead>
            <tbody id="list-scores"></tbody>
        </table>
    </div>

    <div id="sec-report" class="container hidden">
        <h3 style="text-align:left;">–ù–æ–≤—ã–π –æ—Ç—á–µ—Ç</h3>
        <p style="text-align:left; color:#888; font-size:12px; margin-bottom:20px;">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ –∑–∞ –Ω–µ–¥–µ–ª—é</p>
        <label style="display:block; text-align:left; font-size:11px; color:#666; margin-left:5px;">–í–ê–®–ê –î–û–õ–ñ–ù–û–°–¢–¨</label>
        <select id="rep-rank">
            <option value="–ú–ª–∞–¥—à–∏–π –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä">–ú–ª–∞–¥—à–∏–π –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
            <option value="–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
            <option value="–°—Ç–∞—Ä—à–∏–π –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä">–°—Ç–∞—Ä—à–∏–π –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
        </select>
        <textarea id="rep-work" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤—ã —Å–¥–µ–ª–∞–ª–∏..."></textarea>
        <input type="number" id="rep-val" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–¥–∞–Ω–Ω—ã—Ö –Ω–∞–∫–∞–∑–∞–Ω–∏–∏ –∑–∞ –Ω–µ–¥–µ–ª—é (—á–∏—Å–ª–æ)">
        <input type="file" id="rep-files" multiple accept="image/*" style="padding:10px;">
        <input type="date" id="rep-date">
        <button class="btn-action" onclick="sendReport()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</button>
    </div>

    <div id="sec-base" class="container hidden">
        <h3 style="text-align:left; margin-bottom:20px;">üìÅ –ê—Ä—Ö–∏–≤ –≤—Å–µ—Ö –æ—Ç—á–µ—Ç–æ–≤</h3>
        <div id="list-reports"></div>
    </div>

    <div id="sec-admin" class="container hidden">
        <h3 style="text-align:left; margin-bottom:20px;">‚öôÔ∏è –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–æ—Å—Ç–∞–≤–∞</h3>
        <div id="list-users-admin"></div>
    </div>

    <div id="sec-mail" class="container hidden">
        <h3 style="text-align:left; margin-bottom:20px;">üì© –ü–æ—á—Ç–∞–º—Ç –í–ª–∞–¥–µ–ª—å—Ü–∞</h3>
        <div style="background:rgba(255,255,255,0.02); padding:20px; border-radius:12px; border:1px solid var(--border);">
            <label style="font-size:10px; color:#666;">–ü–û–õ–£–ß–ê–¢–ï–õ–¨ (EMAIL)</label>
            <input type="email" id="owner-mail-to" placeholder="user@example.com (–∏–ª–∏ –ø—É—Å—Ç–æ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ –≤—Å–µ–º - –û–ü–ê–°–ù–û!)">
            
            <label style="font-size:10px; color:#666;">–¢–ï–ú–ê</label>
            <input type="text" id="owner-mail-subject" placeholder="–í–∞–∂–Ω–∞—è –Ω–æ–≤–æ—Å—Ç—å">
            
            <label style="font-size:10px; color:#666;">–°–û–û–ë–©–ï–ù–ò–ï</label>
            <textarea id="owner-mail-body" rows="6" placeholder="–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞..."></textarea>
            
            <button class="btn-action" id="btn-owner-send" onclick="sendOwnerEmail()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ</button>
        </div>
    </div>
    
    <div id="sec-logs" class="container hidden">
        <h3 style="text-align:left; margin-bottom:20px;">üìú –õ–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π</h3>
        <div id="logs-list" style="font-size:12px;"></div>
    </div>

</div>

<script>
// ============================================
// CONFIGURATION
// ============================================

const EMAILJS_PUBLIC_KEY = "6aAwXxv7vopj7e7XR";
const EMAILJS_SERVICE_ID = "service_b3voa5p";
const EMAILJS_TEMPLATE_ID = "template_vnltp0b"; 

const firebaseConfig = {
    apiKey: "AIzaSyAmqtdKfR8ZyMoYA2dBno5sGAtJbhmWJEc",
    authDomain: "modersekb.firebaseapp.com",
    projectId: "modersekb",
    databaseURL: "https://modersekb-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// FIX: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è bcrypt (—á–∞—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ dcodeIO)
const bcrypt = window.bcrypt || dcodeIO.bcrypt;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è EmailJS
(function(){
    emailjs.init(EMAILJS_PUBLIC_KEY);
})();

const OWNER = "Ecstasy9988";
const OWNER_PASS_RAW = "Ecstasy20036"; 
let currentUser = "";
let userRole = "pending";
let editingInfoKey = null;

// ============================================
// SECURITY HELPERS & EMAIL FUNCTION
// ============================================

function hashPassword(plain) {
    try {
        const salt = bcrypt.genSaltSync(10);
        return bcrypt.hashSync(plain, salt);
    } catch(e) {
        alert("–û—à–∏–±–∫–∞ –º–æ–¥—É–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
        console.error(e);
        throw e;
    }
}

function checkPassword(plain, stored) {
    if (!stored) return false;
    if (stored.startsWith("$2a$")) {
        return bcrypt.compareSync(plain, stored);
    }
    return plain === stored;
}

// –†–µ–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å—å–º–∞ —á–µ—Ä–µ–∑ EmailJS
function sendEmailReal(to, subject, body) {
    const templateParams = {
        to_email: to,
        subject: subject,  // –í–ê–ñ–ù–û: –í —à–∞–±–ª–æ–Ω–µ EmailJS –ø–æ–ª–µ Subject –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å {{subject}}
        message: body 
    };
    return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
}

// ============================================
// NEW FUNCTION: OWNER SEND EMAIL
// ============================================
function sendOwnerEmail() {
    if (currentUser !== OWNER) return alert("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!");
    
    const to = document.getElementById('owner-mail-to').value.trim();
    const sub = document.getElementById('owner-mail-subject').value.trim();
    const msg = document.getElementById('owner-mail-body').value.trim();
    
    if(!sub || !msg) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–º—É –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ");
    
    const btn = document.getElementById('btn-owner-send');
    btn.disabled = true;
    btn.innerText = "–û—Ç–ø—Ä–∞–≤–∫–∞...";

    if(to) {
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–¥–Ω–æ–º—É
        sendEmailReal(to, sub, msg)
            .then(() => alert("–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: " + to))
            .catch(e => alert("–û—à–∏–±–∫–∞: " + JSON.stringify(e)))
            .finally(() => { btn.disabled = false; btn.innerText = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ"; });
    } else {
        // –†–∞—Å—Å—ã–ª–∫–∞ (–û–ü–ê–°–ù–û: –õ–∏–º–∏—Ç—ã EmailJS)
        if(!confirm("–í–Ω–∏–º–∞–Ω–∏–µ! –í—ã –Ω–µ —É–∫–∞–∑–∞–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –í–°–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–æ–π –ø–æ—á—Ç–æ–π?")) {
            btn.disabled = false; 
            btn.innerText = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ";
            return;
        }

        db.ref('users').once('value', s => {
            const users = s.val() || {};
            let emails = [];
            Object.values(users).forEach(u => {
                if(u.email && u.emailVerified) emails.push(u.email);
            });
            
            if(emails.length === 0) {
                btn.disabled = false;
                btn.innerText = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ";
                return alert("–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–æ–π –ø–æ—á—Ç–æ–π.");
            }

            let sentCount = 0;
            // –ü—Ä–æ—Å—Ç–æ–π —Ü–∏–∫–ª (EmailJS –º–æ–∂–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É)
            emails.forEach(email => {
                sendEmailReal(email, sub, msg);
                sentCount++;
            });
            
            alert(`–ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—É—â–µ–Ω–∞ –¥–ª—è ${sentCount} –∞–¥—Ä–µ—Å–æ–≤.`);
            btn.disabled = false;
            btn.innerText = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ";
        });
    }
}

// ============================================
// CORE AUTH LOGIC
// ============================================

function updateLastSeen() {
    if(currentUser) db.ref('users/' + currentUser + '/lastSeen').set(Date.now());
}

function nav(id) {
    if (userRole === 'pending' && id !== 'profile') return;
    
    if(currentUser && document.getElementById('email-blocker').style.display === 'flex') {
        return;
    }

    updateLastSeen();
    document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
    document.getElementById('sec-' + id).classList.remove('hidden');
    window.scrollTo(0,0);
}

function toggleAuth(mode) {
    document.getElementById('box-log').classList.toggle('hidden', mode !== 'log');
    document.getElementById('box-reg').classList.toggle('hidden', mode !== 'reg');
    document.getElementById('box-reset').classList.toggle('hidden', mode !== 'reset');
}

function doLogin() {
    const l = document.getElementById('in-log-login').value.trim();
    const p = document.getElementById('in-log-pass').value.trim();
    if(!l || !p) return alert("–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å");

    if (l === OWNER && p === OWNER_PASS_RAW) { 
        loginSuccess(l, 'owner'); 
        return; 
    }

    db.ref('users/' + l).once('value', s => {
        const d = s.val();
        if (d && checkPassword(p, d.pass)) {
            if (!d.pass.startsWith("$2a$")) {
                db.ref('users/' + l + '/pass').set(hashPassword(p));
            }
            loginSuccess(l, d.role);
        } else {
            alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å");
        }
    });
}

// FIXED: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏)
function doRegister() {
    const l = document.getElementById('in-reg-login').value.trim();
    const p = document.getElementById('in-reg-pass').value.trim();
    const email = document.getElementById('in-reg-email').value.trim();
    
    if (!l || !p || !email) return alert("–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã, –≤–∫–ª—é—á–∞—è Email");
    if (!email.includes('@')) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Email");
    
    // FIX: Firebase –∑–∞–ø—Ä–µ—â–∞–µ—Ç —ç—Ç–∏ —Å–∏–º–≤–æ–ª—ã –≤ –ø—É—Ç—è—Ö (–∫–ª—é—á–∞—Ö)
    if (l.match(/[.#$[\]]/)) return alert("–ù–∏–∫–Ω–µ–π–º –Ω–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–∏–º–≤–æ–ª—ã: . # $ [ ]");

    db.ref('users/' + l).once('value', snapshot => {
        if(snapshot.exists()) return alert("–¢–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
        
        try {
            const hashedPass = hashPassword(p);
            
            const newUser = { 
                pass: hashedPass, 
                nick: l, 
                role: 'pending', 
                score: 0, 
                rank: '–ú–ª–∞–¥—à–∏–π –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä', 
                avatar: '', 
                reportsCount: 0, 
                warns: 0, 
                inactive: false, 
                lastReportTime: 0, 
                lastSeen: Date.now(),
                email: email,
                emailVerified: false
            };

            // WAITING FOR DB WRITE BEFORE LOGIN
            db.ref('users/' + l).set(newUser)
                .then(() => {
                    alert("–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!");
                    loginSuccess(l, 'pending');
                })
                .catch(error => {
                    alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ (Firebase): " + error.message);
                    console.error(error);
                });

        } catch (e) {
            alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑. –í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ –ø—Ä–æ–≥—Ä—É–∑–∏–ª—Å—è –º–æ–¥—É–ª—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è.");
            console.error(e);
        }
    });
}

function loginSuccess(l, role) {
    currentUser = l;
    userRole = (l === OWNER) ? 'owner' : (role || 'pending');
    localStorage.setItem('mod_user', l);

    document.getElementById('auth-section').classList.add('hidden');
    document.getElementById('app-section').classList.remove('hidden');
    document.querySelector('#user-tag span').innerText = l;
    
    const isApproved = (userRole !== 'pending');
    document.querySelectorAll('.approval-hide').forEach(el => el.classList.toggle('hidden', !isApproved));
    document.getElementById('pending-msg').classList.toggle('hidden', isApproved);

    const isAdmin = (userRole === 'admin' || userRole === 'owner');
    const isOwner = (currentUser === OWNER);

    document.getElementById('nav-base').classList.toggle('hidden', !isAdmin);
    document.getElementById('nav-admin').classList.toggle('hidden', !isAdmin);
    document.getElementById('nav-mail').classList.toggle('hidden', !isOwner); // –¢–æ–ª—å–∫–æ –í–ª–∞–¥–µ–ª–µ—Ü
    document.getElementById('add-table-row').classList.toggle('hidden', !isAdmin);
    document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdmin));
    
    document.getElementById('admin-info-controls').classList.toggle('hidden', !isAdmin);
    document.getElementById('admin-shop-controls').classList.toggle('hidden', !isAdmin);

    updateLastSeen();
    checkEmailStatus(); 
    
    showProfile(l);
    loadData();
    loadFullTable(); 
    loadLogs();
    loadInfo();
    loadShop();
    setInterval(updateLastSeen, 60000);

    db.ref('users/' + l).on('value', s => {
        if (!navigator.onLine) return;
        const data = s.val();
        if (!data && currentUser !== OWNER) {
            logout();
            return;
        }
        if (data && data.role && data.role !== userRole) {
            const oldRole = userRole;
            userRole = data.role;
            if(oldRole !== userRole) location.reload(); 
        }
        if (data && data.emailVerified) {
            document.getElementById('email-blocker').style.display = 'none';
        }
    });
}

// ============================================
// EMAIL VERIFICATION & RESET
// ============================================

function checkEmailStatus() {
    if(!currentUser) return;
    db.ref('users/' + currentUser).once('value', s => {
        const u = s.val();
        if(u && !u.emailVerified) {
            document.getElementById('email-blocker').style.display = 'flex';
            if(u.email) {
                document.getElementById('bind-email-input').value = u.email;
            }
        } else {
            document.getElementById('email-blocker').style.display = 'none';
        }
    });
}

function sendVerificationCode() {
    const emailInput = document.getElementById('bind-email-input').value.trim();
    if(!emailInput || !emailInput.includes('@')) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Email");

    const btn = document.getElementById('btn-send-code');
    btn.disabled = true;
    btn.innerText = "–û—Ç–ø—Ä–∞–≤–∫–∞...";

    const code = Math.floor(100000 + Math.random() * 900000).toString();
    
    db.ref('users/' + currentUser).update({
        email: emailInput,
        verificationCode: code
    }).then(() => {
        sendEmailReal(emailInput, "–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è MOD EKB", `–í–∞—à –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞: ${code}`)
            .then(() => {
                alert("–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ " + emailInput);
                document.getElementById('step-bind-email').classList.add('hidden');
                document.getElementById('step-verify-code').classList.remove('hidden');
            })
            .catch((err) => {
                console.error(err);
                alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerText = "–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥";
            });
    });
}

function confirmEmailCode() {
    const codeInput = document.getElementById('verify-code-input').value.trim();
    db.ref('users/' + currentUser).once('value', s => {
        const u = s.val();
        if(u.verificationCode == codeInput) {
            db.ref('users/' + currentUser).update({
                emailVerified: true,
                verificationCode: null
            });
            document.getElementById('email-blocker').style.display = 'none';
            alert("–ü–æ—á—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –î–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç.");
            addLog("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ—á—Ç—É", currentUser);
        } else {
            alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥!");
        }
    });
}

let resetEmailTarget = "";
function initiateReset() {
    const email = document.getElementById('reset-email').value.trim();
    if(!email) return alert("–í–≤–µ–¥–∏—Ç–µ –ø–æ—á—Ç—É");
    
    const btn = document.getElementById('btn-reset-send');
    btn.disabled = true;
    btn.innerText = "–ü–æ–∏—Å–∫...";

    db.ref('users').orderByChild('email').equalTo(email).once('value', s => {
        if(!s.exists()) {
            btn.disabled = false;
            btn.innerText = "–°–±—Ä–æ—Å–∏—Ç—å";
            return alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–æ–π –ø–æ—á—Ç–æ–π –Ω–µ –Ω–∞–π–¥–µ–Ω.");
        }
        
        const uData = s.val();
        const nick = Object.keys(uData)[0];
        resetEmailTarget = nick;

        const code = Math.floor(100000 + Math.random() * 900000).toString();
        db.ref('users/' + nick + '/verificationCode').set(code);
        
        btn.innerText = "–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å—å–º–∞...";
        
        sendEmailReal(email, "–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è MOD EKB", `–ö–æ–¥ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è: ${code}`)
            .then(() => {
                document.getElementById('reset-step-1').classList.add('hidden');
                document.getElementById('reset-step-2').classList.remove('hidden');
            })
            .catch((err) => {
                console.error(err);
                alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏.");
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerText = "–°–±—Ä–æ—Å–∏—Ç—å";
            });
    });
}

function confirmReset() {
    const code = document.getElementById('reset-code').value.trim();
    const newPass = document.getElementById('reset-new-pass').value.trim();
    
    if(!code || !newPass) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è");

    db.ref('users/' + resetEmailTarget).once('value', s => {
        const u = s.val();
        if(u.verificationCode == code) {
            const hashed = hashPassword(newPass);
            db.ref('users/' + resetEmailTarget).update({
                pass: hashed,
                verificationCode: null
            });
            alert("–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.");
            location.reload();
        } else {
            alert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥");
        }
    });
}

// ============================================
// APP LOGIC
// ============================================

function showProfile(nick) {
    nav('profile');
    const isMe = nick === currentUser;
    const isPending = (userRole === 'pending');

    const statsContainer = document.getElementById('profile-stats-container');
    if (isMe && isPending) statsContainer.classList.add('hidden');
    else statsContainer.classList.remove('hidden');

    const controls = document.getElementById('my-profile-controls');
    if (isMe && !isPending) controls.classList.remove('hidden');
    else controls.classList.add('hidden');
    
    const isAdmin = (userRole === 'admin' || userRole === 'owner');
    const canManage = isAdmin && (nick !== OWNER || currentUser === OWNER);
    document.getElementById('admin-full-controls').classList.toggle('hidden', !canManage);

    db.ref('users/' + nick).on('value', s => {
        const d = s.val() || {};
        if(!s.exists()) return;

        const warns = d.warns || 0;
        const score = d.score || 0;
        const isInactive = d.inactive || false;
        const lastSeen = d.lastSeen ? new Date(d.lastSeen).toLocaleString() : "–ù–∏–∫–æ–≥–¥–∞";
        
        document.getElementById('view-nick').innerText = d.nick || nick;
        document.getElementById('view-rank').innerText = (isMe && isPending) ? "–û–∂–∏–¥–∞–Ω–∏–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è" : (d.rank || "–£—á–∞—Å—Ç–Ω–∏–∫");
        document.getElementById('view-score').innerText = score;
        document.getElementById('view-ava').src = d.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + nick;
        
        document.getElementById('view-warns-num').innerText = `${warns}/3`;
        document.getElementById('view-lastseen').innerText = `–í —Å–µ—Ç–∏: ${lastSeen}`;
        
        const progress = (score % 500) / 5;
        document.getElementById('rank-progress').style.width = progress + "%";
        
        document.getElementById('inactive-tag').classList.toggle('hidden', !isInactive);
        if (isMe && !isPending) {
            document.getElementById('btn-take-inactive').classList.toggle('hidden', isInactive);
            document.getElementById('btn-exit-inactive').classList.toggle('hidden', !isInactive);
        }

        if(canManage) {
            document.getElementById('edit-nick-input').value = d.nick || nick;
            document.getElementById('edit-rank-input').value = d.rank || "";

            document.getElementById('btn-save-admin').onclick = () => {
                const newNick = document.getElementById('edit-nick-input').value;
                const newRank = document.getElementById('edit-rank-input').value;
                db.ref('users/' + nick).update({ nick: newNick, rank: newRank });
                alert("–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã");
            };

            document.getElementById('btn-add-warn').onclick = () => {
                db.ref(`users/${nick}/warns`).set(warns + 1);
                addLog('–í—ã–¥–∞–ª –≤—ã–≥–æ–≤–æ—Ä', nick);
            };
            document.getElementById('btn-rem-warn').onclick = () => {
                db.ref(`users/${nick}/warns`).set(Math.max(0, warns - 1));
                addLog('–°–Ω—è–ª –≤—ã–≥–æ–≤–æ—Ä (–∞–¥–º–∏–Ω)', nick);
            };
            
            document.getElementById('btn-toggle-top').onclick = () => {
                const cur = d.hiddenFromTop || false;
                db.ref('users/' + nick + '/hiddenFromTop').set(!cur);
                alert(!cur ? "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–±—Ä–∞–Ω –∏–∑ –¢–û–ü–∞" : "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–µ–Ω –≤ –¢–û–ü");
            };

            document.getElementById('btn-delete-user').onclick = () => {
                if(nick === OWNER) return alert("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞");
                if(confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ö–ò–ö–ù–£–¢–¨ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${nick}?`)) {
                    db.ref('users/' + nick).remove();
                    addLog('–ö–∏–∫–Ω—É–ª (–£–¥–∞–ª–∏–ª)', nick);
                    alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–∏–∫–Ω—É—Ç –∏ —É–¥–∞–ª–µ–Ω.");
                    nav('admin');
                }
            };
        }
        document.getElementById('stat-count').innerText = d.reportsCount || 0;
    });
}

function loadData() {
    db.ref('users').on('value', s => {
        const users = s.val() || {};
        const listTop = document.getElementById('list-scores');
        const listAdmin = document.getElementById('list-users-admin');
        const isAdmin = (userRole === 'admin' || userRole === 'owner');
        const now = Date.now();
        
        // OPTIMIZATION: Use arrays instead of innerHTML += loops
        let topRows = [];
        let adminRows = [];
        
        Object.entries(users).sort((a,b) => (b[1].score || 0) - (a[1].score || 0)).forEach(([id, u]) => {
            const isOnline = u.lastSeen && (now - u.lastSeen < 300000);
            const dotClass = isOnline ? 'dot-green' : 'dot-red';
            const userAva = u.avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + id;

            if (isAdmin) {
                let adminButtons = "";
                if(u.role === 'pending') {
                    adminButtons += `<button class="btn-nav" style="padding: 4px 10px; background:var(--primary); color:black;" onclick="db.ref('users/${id}/role').set('user')">–û–¥–æ–±—Ä–∏—Ç—å –∑–∞—è–≤–∫—É</button>`;
                } else if(u.role !== 'owner') {
                    if(u.role === 'admin') {
                        adminButtons += `<button class="btn-nav" style="padding: 4px 10px;" onclick="db.ref('users/${id}/role').set('user')">–°–Ω—è—Ç—å –ê–¥–º–∏–Ω–∫—É</button>`;
                    } else {
                        adminButtons += `<button class="btn-nav" style="padding: 4px 10px;" onclick="db.ref('users/${id}/role').set('admin')">–í—ã–¥–∞—Ç—å –ê–¥–º–∏–Ω–∫—É</button>`;
                    }
                }

                adminRows.push(`
                <div class="report-card" style="margin-bottom: 10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span>
                            <img src="${userAva}" class="mini-avatar">
                            <div class="online-dot ${dotClass}"></div> 
                            <b>${u.nick || id}</b> 
                            <small style="opacity:0.5; color:${u.role === 'pending' ? 'var(--danger)' : 'inherit'}">(${u.role})</small>
                        </span>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <button class="btn-nav" style="padding: 4px 10px;" onclick="showProfile('${id}')">–£–ø—Ä–∞–≤–ª—è—Ç—å</button>
                            <span onclick="deleteUserSimple('${id}')" style="color:var(--danger); cursor:pointer; font-weight:bold; padding:5px;">‚úï</span>
                        </div>
                    </div>
                    <div style="margin-top:10px; display:flex; gap:5px; flex-wrap:wrap;">
                        ${adminButtons}
                    </div>
                </div>`);
            }

            if (u.role !== 'pending' && !u.hiddenFromTop) {
                topRows.push(`
                    <tr>
                    <td onclick="showProfile('${id}')" style="cursor:pointer;">
                        <img src="${userAva}" class="mini-avatar">
                        <div class="online-dot ${dotClass}"></div> ${u.nick || id}
                    </td>
                    <td style="font-size:10px; opacity:0.7;">${u.rank}</td>
                    <td class="${isAdmin ? 'editable' : ''}" style="color:var(--primary); font-weight:bold;" onclick="editUserScore('${id}', ${u.score})">${u.score}</td>
                    </tr>
                `);
            }
        });
        
        // Single DOM update
        listTop.innerHTML = topRows.join('');
        listAdmin.innerHTML = adminRows.join('');
    });

    db.ref('reports').on('value', s => {
        const container = document.getElementById('list-reports');
        const isAdmin = (userRole === 'admin' || userRole === 'owner');
        
        let reportHtml = [];
        Object.entries(s.val() || {}).reverse().forEach(([id, r]) => {
            let imgsHtml = "";
            if(r.imgs) r.imgs.forEach(src => imgsHtml += `<img src="${src}" onclick="viewImg('${src}')" style="width:80px; height:80px; object-fit:cover; border-radius:8px; margin:5px; cursor:pointer; border:1px solid var(--border);">`);
            
            const delBtn = isAdmin ? `<span onclick="deleteReport('${id}', '${r.author}', ${r.score})" style="color:var(--danger); cursor:pointer; font-weight:bold; padding:5px; margin-left:10px;">‚úï</span>` : "";

            reportHtml.push(`
            <div class="report-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <b>${r.author}</b>
                    <div>
                        <span style="color:var(--primary)">+${r.score} –±–∞–ª–ª–æ–≤</span>
                        ${delBtn}
                    </div>
                </div>
                <div style="font-size:12px; margin:10px 0; color:#ccc;">${r.work}</div>
                <div>${imgsHtml}</div>
                <div style="font-size:9px; color:#555; margin-top:10px;">–î–∞—Ç–∞: ${r.date}</div>
            </div>`);
        });
        container.innerHTML = reportHtml.join('');
    });
}

function loadFullTable() {
    db.ref('full_table').on('value', s => {
        const tbody = document.getElementById('tbody-full');
        const isAdmin = (userRole === 'admin' || userRole === 'owner');
        const now = new Date();

        const calcDays = (dateStr) => {
            if (!dateStr || dateStr === '-') return '0';
            const parts = dateStr.split('.');
            if(parts.length === 3) {
                const d = new Date(parts[2], parts[1]-1, parts[0]);
                if(!isNaN(d)) return Math.floor((now - d) / (1000 * 60 * 60 * 24));
            }
            return '0';
        };

        const dataObj = s.val() || {};
        let rows = Object.keys(dataObj).map(key => ({
            key: key,
            ...dataObj[key]
        }));

        rows.sort((a, b) => (a.order || 0) - (b.order || 0));

        let tableHtml = [];
        rows.forEach((row) => {
            const key = row.key;
            const daysSinceStart = calcDays(row.dateStart);
            const daysSinceUp = calcDays(row.lastUp);

            const moveControls = isAdmin ? `
                <td style="white-space:nowrap;">
                    <button class="btn-small-icon" onclick="moveRow('${key}', -1)">‚¨Ü</button>
                    <button class="btn-small-icon" onclick="moveRow('${key}', 1)">‚¨á</button>
                </td>
            ` : '';

            tableHtml.push(`
            <tr>
                ${moveControls}
                <td class="${isAdmin ? 'editable' : ''}" onclick="editCell('${key}', 'nick', '${row.nick}')">${row.nick || 'None'}</td>
                <td class="${isAdmin ? 'editable' : ''}" onclick="editCell('${key}', 'rank', '${row.rank}')">${row.rank || 'None'}</td>
                <td class="${isAdmin ? 'editable' : ''}" onclick="editCell('${key}', 'dateStart', '${row.dateStart}')">${row.dateStart || '01.01.2024'}</td>
                <td style="color:var(--primary)">${daysSinceStart} –¥–Ω.</td>
                <td class="${isAdmin ? 'editable' : ''}" onclick="editCell('${key}', 'preds', '${row.preds}')">${row.preds || '[0/2]'}</td>
                <td class="${isAdmin ? 'editable' : ''}" onclick="editCell('${key}', 'warns', '${row.warns}')">${row.warns || '[0/3]'}</td>
                <td class="${isAdmin ? 'editable' : ''}" onclick="editCell('${key}', 'lastUp', '${row.lastUp}')">${row.lastUp || '-'}</td>
                <td style="color:#ffd600">${daysSinceUp} –¥–Ω.</td>
                ${isAdmin ? `<td><span onclick="db.ref('full_table/${key}').remove()" style="color:var(--danger); cursor:pointer;">–£–¥–∞–ª–∏—Ç—å</span></td>` : ''}
            </tr>`);
        });
        tbody.innerHTML = tableHtml.join('');
    });
}

function moveRow(key, direction) {
    db.ref('full_table').once('value', s => {
        const dataObj = s.val() || {};
        let rows = Object.keys(dataObj).map(k => ({ key: k, ...dataObj[k] }));
        rows.sort((a, b) => (a.order || 0) - (b.order || 0));
        const index = rows.findIndex(r => r.key === key);
        if (index === -1) return;
        const targetIndex = index + direction;
        if (targetIndex < 0 || targetIndex >= rows.length) return;
        [rows[index], rows[targetIndex]] = [rows[targetIndex], rows[index]];
        const updates = {};
        rows.forEach((row, i) => { updates[`full_table/${row.key}/order`] = i; });
        db.ref().update(updates);
    });
}

function addTableRow() {
    db.ref('full_table').once('value', s => {
        const count = s.numChildren();
        db.ref('full_table').push({
            nick: 'Nick_Name',
            rank: '–î–æ–ª–∂–Ω–æ—Å—Ç—å',
            dateStart: new Date().toLocaleDateString('ru-RU'),
            preds: '[0/2]',
            warns: '[0/3]',
            lastUp: '-',
            order: count
        });
    });
}

function editCell(key, field, oldVal) {
    if (userRole !== 'admin' && userRole !== 'owner') return;
    const newVal = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:", oldVal);
    if (newVal !== null) db.ref(`full_table/${key}/${field}`).set(newVal);
}

function editUserScore(id, oldScore) {
    if (userRole !== 'admin' && userRole !== 'owner') return;
    const newScore = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞–ª–ª–æ–≤ –¥–ª—è " + id + ":", oldScore);
    if (newScore !== null && !isNaN(parseInt(newScore))) {
        db.ref(`users/${id}/score`).set(parseInt(newScore));
    }
}

function deleteReport(repId, author, points) {
    if(confirm(`–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç—á–µ—Ç? –£ –∞–≤—Ç–æ—Ä–∞ (${author}) –±—É–¥–µ—Ç —Å–ø–∏—Å–∞–Ω–æ ${points} –±–∞–ª–ª–æ–≤.`)) {
        db.ref('reports/' + repId).remove();
        db.ref('users/' + author).transaction(u => {
            if(u) {
                u.score = Math.max(0, (u.score || 0) - points);
                u.reportsCount = Math.max(0, (u.reportsCount || 0) - 1);
            }
            return u;
        });
        addLog(`–£–¥–∞–ª–∏–ª –æ—Ç—á–µ—Ç ${author}`, currentUser);
        alert("–û—Ç—á–µ—Ç —É–¥–∞–ª–µ–Ω, –±–∞–ª–ª—ã —Å–ø–∏—Å–∞–Ω—ã.");
    }
}

function deleteUserSimple(id) {
    if(id === OWNER) return alert("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞");
    if(confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã? –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${id} –±—É–¥–µ—Ç –ö–ò–ö–ù–£–¢ –∏ –£–î–ê–õ–ï–ù.`)) {
        db.ref('users/' + id).remove();
        addLog(`–ö–∏–∫–Ω—É–ª (–£–¥–∞–ª–∏–ª) ${id}`, currentUser);
    }
}

async function sendReport() {
    if (userRole === 'pending') return;
    const work = document.getElementById('rep-work').value;
    const score = parseInt(document.getElementById('rep-val').value);
    const date = document.getElementById('rep-date').value;
    const files = document.getElementById('rep-files').files;

    if(!work || isNaN(score) || !date) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!");

    let imgs = [];
    for(let f of files) {
        const b64 = await new Promise(res => {
            const reader = new FileReader();
            reader.onload = () => res(reader.result);
            reader.readAsDataURL(f);
        });
        imgs.push(b64);
    }

function submitReport() {
    // ... —Ç–≤–æ–π –∫–æ–¥ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ input'–æ–≤ (role, nick, work –∏ —Ç.–¥.) ...
    
    // –ü–†–û–í–ï–†–ö–ê: –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç
    const reportData = {
        role: document.getElementById('rep-role').value, // –ø—Ä–∏–º–µ—Ä ID
        author: document.getElementById('rep-nick').value, // –ù–ò–ö–ù–ï–ô–ú –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
        nickname: document.getElementById('rep-nick').value, 
        work: document.getElementById('rep-work').value,
        punishments: document.getElementById('rep-punish').value,
        date: document.getElementById('rep-date').value,
        score: 5, // –ò–ª–∏ —Å–∫–æ–ª—å–∫–æ –±–∞–ª–ª–æ–≤ —Ç—ã –¥–∞–µ—à—å –∑–∞ –æ—Ç—á–µ—Ç
        
        // –í–ê–ñ–ù–û –î–õ–Ø –ë–û–¢–ê:
        timestamp: firebase.database.ServerValue.TIMESTAMP, 
        
        // –ï—Å–ª–∏ —É —Ç–µ–±—è –º–∞—Å—Å–∏–≤ —Ñ–æ—Ç–æ imgs –∏–ª–∏ —Å—Å—ã–ª–∫–∞ photoUrl
        // imgs: [...], 
        // photoUrl: "..."
    };

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ reports (–ù–ï –≤ pending_reports, —Ç–∞–∫ –∫–∞–∫ –±–æ—Ç —Å–ª—É—à–∞–µ—Ç reports)
    db.ref('reports').push(reportData)
      .then(() => alert("–û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!"))
      .catch(e => alert("–û—à–∏–±–∫–∞: " + e.message));
}

function viewImg(src) { document.getElementById('modal-img').src = src; document.getElementById('modal').style.display = 'flex'; }

async function uploadAva(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        if (file.size > 1024 * 1024) return alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –õ–∏–º–∏—Ç 1–ú–ë.");
        const b64 = await new Promise(res => {
            const reader = new FileReader();
            reader.onload = () => res(reader.result);
            reader.readAsDataURL(file);
        });
        db.ref('users/' + currentUser).update({ avatar: b64 });
        alert("–§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!");
    }
}

function changeNick() { 
    const name = prompt("–í–∞—à –Ω–æ–≤—ã–π –Ω–∏–∫:"); 
    if(name) {
        // FIX: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∏–∫–∞ –∏ –∑–¥–µ—Å—å
        if (name.match(/[.#$[\]]/)) return alert("–ù–∏–∫–Ω–µ–π–º –Ω–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–∏–º–≤–æ–ª—ã: . # $ [ ]");
        db.ref('users/' + currentUser).update({ nick: name }); 
        addLog('–°–º–µ–Ω–∏–ª –Ω–∏–∫ –Ω–∞ ' + name, currentUser);
    }
}

function logout() { localStorage.clear(); location.reload(); }

function addLog(action, target = currentUser) {
    db.ref('logs').push({ action, target, by: currentUser, time: new Date().toLocaleString() });
}

function skipMeeting() {
    db.ref('users/' + currentUser).once('value', s => {
        const u = s.val();
        if(u.score < 5) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ (–Ω—É–∂–Ω–æ 5)");
        db.ref('users/' + currentUser).update({ score: u.score - 5 });
        addLog('–ü—Ä–æ–ø—É—Å–∫ —Å–æ–±—Ä–∞–Ω–∏—è', currentUser); alert("–ü—Ä–æ–ø—É—Å–∫ —Å–æ–±—Ä–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω");
    });
}

function removeWarn() {
    db.ref('users/' + currentUser).once('value', s => {
        const u = s.val();
        if(u.warns <= 0) return alert("–ù–µ—Ç –≤—ã–≥–æ–≤–æ—Ä–æ–≤");
        if(u.score < 10) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ (–Ω—É–∂–Ω–æ 10)");
        db.ref('users/' + currentUser).update({ warns: Math.max(0, u.warns - 1), score: u.score - 10 });
        addLog('–°–Ω—è–ª –≤—ã–≥–æ–≤–æ—Ä —Å–µ–±–µ', currentUser); alert("–í—ã–≥–æ–≤–æ—Ä —Å–Ω—è—Ç");
    });
}

function takeInactive() {
    const days = prompt("–ù–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –≤–∑—è—Ç—å –Ω–µ–∞–∫—Ç–∏–≤? (1-7)");
    if(!days) return;
    const d = parseInt(days);
    if(isNaN(d) || d < 1 || d > 7) return alert("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 7");
    db.ref('users/' + currentUser).once('value', s => {
        const u = s.val();
        if(u.inactive) return alert("–£–∂–µ –≤ –Ω–µ–∞–∫—Ç–∏–≤–µ");
        if(u.score < 10) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ (–Ω—É–∂–Ω–æ 10)");
        db.ref('users/' + currentUser).update({ inactive: true, inactiveUntil: Date.now() + (d * 86400000), score: u.score - 10 });
        addLog(`–í–∑—è–ª –Ω–µ–∞–∫—Ç–∏–≤ –Ω–∞ ${d} –¥–Ω.`, currentUser);
        alert("–ù–µ–∞–∫—Ç–∏–≤ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω");
    });
}

function exitInactive() {
    if(confirm("–í—ã–π—Ç–∏ –∏–∑ –Ω–µ–∞–∫—Ç–∏–≤–∞?")) {
        db.ref('users/' + currentUser).update({ inactive: false });
        addLog('–í—ã—à–µ–ª –∏–∑ –Ω–µ–∞–∫—Ç–∏–≤–∞', currentUser);
    }
}

async function addInfoPost() {
    const title = document.getElementById('info-new-title').value;
    const text = document.getElementById('info-new-text').value;
    const file = document.getElementById('info-new-img').files[0];
    if(!title || !text) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç");
    let img = "";
    if(file) {
        img = await new Promise(res => {
            const r = new FileReader();
            r.onload = () => res(r.result);
            r.readAsDataURL(file);
        });
    }
    if (editingInfoKey) {
        const updates = { title, text, date: Date.now() };
        if (img) updates.img = img;
        db.ref('info_posts/' + editingInfoKey).update(updates);
        addLog('–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª –ø–æ—Å—Ç –≤ –ò–ù–§–û', currentUser);
        cancelEditInfo();
    } else {
        db.ref('info_posts').push({ title, text, img, date: Date.now() });
        addLog('–î–æ–±–∞–≤–∏–ª –ø–æ—Å—Ç –≤ –ò–ù–§–û', currentUser);
        cancelEditInfo();
    }
}

function editInfo(key) {
    db.ref('info_posts/' + key).once('value', s => {
        const d = s.val();
        document.getElementById('info-new-title').value = d.title;
        document.getElementById('info-new-text').value = d.text;
        editingInfoKey = key;
        document.getElementById('btn-publish-info').innerText = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
        document.getElementById('btn-cancel-info').classList.remove('hidden');
    });
}

function cancelEditInfo() {
    editingInfoKey = null;
    document.getElementById('info-new-title').value = "";
    document.getElementById('info-new-text').value = "";
    document.getElementById('btn-publish-info').innerText = "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å";
    document.getElementById('btn-cancel-info').classList.add('hidden');
}

function loadInfo() {
    db.ref('info_posts').on('value', s => {
        const list = document.getElementById('info-list');
        const isAdmin = (userRole === 'admin' || userRole === 'owner');
        
        let html = [];
        Object.entries(s.val() || {}).reverse().forEach(([key, post]) => {
            const imgHtml = post.img ? `<img src="${post.img}" class="info-img" onclick="viewImg('${post.img}')">` : '';
            const controls = isAdmin ? `<div class="info-controls"><button onclick="editInfo('${key}')" class="btn-small-icon">‚úèÔ∏è</button><button onclick="if(confirm('–£–¥–∞–ª–∏—Ç—å?')) db.ref('info_posts/${key}').remove()" class="btn-small-icon" style="color:var(--danger)">‚úï</button></div>` : "";
            html.push(`<div class="info-post">${controls}<h3 style="margin-top:0; color:var(--primary); padding-right: 50px;">${post.title}</h3><div style="white-space: pre-wrap; font-size:13px; color:#ddd;">${post.text}</div>${imgHtml}</div>`);
        });
        list.innerHTML = html.join('');
    });
}

function addShopItem() {
    const name = document.getElementById('shop-new-name').value;
    const price = parseInt(document.getElementById('shop-new-price').value);
    if(!name || isNaN(price)) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ");
    db.ref('shop_items').push({ name, price });
    document.getElementById('shop-new-name').value = "";
    document.getElementById('shop-new-price').value = "";
}

function loadShop() {
    db.ref('shop_items').on('value', s => {
        const list = document.getElementById('shop-items-list');
        const isAdmin = (userRole === 'admin' || userRole === 'owner');
        let html = [];
        Object.entries(s.val() || {}).forEach(([key, item]) => {
            const delBtn = isAdmin ? `<span onclick="db.ref('shop_items/${key}').remove()" style="position:absolute; top:5px; right:5px; color:var(--danger); cursor:pointer;">‚úï</span>` : "";
            html.push(`
            <div class="shop-item">
                ${delBtn}
                <div style="font-weight:bold; font-size:14px;">${item.name}</div>
                <div class="shop-price">${item.price} <small>–±–∞–ª–ª–æ–≤</small></div>
                <button class="btn-buy" onclick="buyItem('${key}', ${item.price}, '${item.name}')">–ö—É–ø–∏—Ç—å</button>
            </div>`);
        });
        list.innerHTML = html.join('');
    });
}

function buyItem(key, price, name) {
    if(!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å "${name}" –∑–∞ ${price} –±–∞–ª–ª–æ–≤?`)) return;
    db.ref('users/' + currentUser).once('value', s => {
        const u = s.val();
        if(u.score < price) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏!");
        db.ref('users/' + currentUser).update({ score: u.score - price });
        addLog(`–ö–£–ü–ò–õ –í –ú–ê–ì–ê–ó–ò–ù–ï: ${name}`, currentUser);
        alert(`–ü–æ–∫—É–ø–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞! –°–ø–∏—Å–∞–Ω–æ ${price} –±–∞–ª–ª–æ–≤. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è.`);
    });
}

let isSpinning = false;
async function spinRoulette() {
    if (isSpinning) return;
    const SPIN_COST = 15;
    
    const userSnap = await db.ref('users/' + currentUser).get();
    const userData = userSnap.val();
    if (userData.score < SPIN_COST) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤ –¥–ª—è –≤—Ä–∞—â–µ–Ω–∏—è (–Ω—É–∂–Ω–æ " + SPIN_COST + ")");

    const shopSnap = await db.ref('shop_items').get();
    const items = shopSnap.val() || {};
    
    let prizes = [
        { name: "20 –±–∞–ª–ª–æ–≤", type: "score", val: 20 },
        { name: "5 –±–∞–ª–ª–æ–≤", type: "score", val: 5 },
        { name: "–ù–ò–ß–ï–ì–û", type: "nothing", val: 0 }
    ];
    Object.values(items).forEach(it => prizes.push({ name: it.name, type: "item", val: it.name }));

    isSpinning = true;
    document.getElementById('btn-spin').disabled = true;
    document.getElementById('roulette-result').innerText = "–ö—Ä—É—Ç–∏–º...";
    
    const reel = document.getElementById('roulette-reel');
    reel.style.transition = "none";
    reel.style.transform = "translateX(0)";
    reel.innerHTML = "";
    
    const count = 80;
    const fullList = [];
    for(let i=0; i<count; i++) {
        const p = prizes[Math.floor(Math.random() * prizes.length)];
        fullList.push(p);
        const div = document.createElement('div');
        div.className = 'reel-item';
        div.innerText = p.name;
        reel.appendChild(div);
    }

    db.ref('users/' + currentUser + '/score').set(userData.score - SPIN_COST);

    const winIndex = 75;
    const winner = fullList[winIndex];

    setTimeout(() => {
        reel.style.transition = "transform 4s cubic-bezier(0.1, 0, 0.1, 1)";
        const shift = winIndex * 100 - (140 - 50); 
        reel.style.transform = `translateX(-${shift}px)`;
    }, 50);

    setTimeout(() => {
        isSpinning = false;
        document.getElementById('btn-spin').disabled = false;
        
        let resMsg = "";
        if (winner.type === "score") {
            db.ref('users/' + currentUser + '/score').transaction(s => (s || 0) + winner.val);
            resMsg = `–í–´–ò–ì–†–´–®: ${winner.name}!`;
        } else if (winner.type === "item") {
            resMsg = `–í–´–ò–ì–†–´–®: ${winner.name}! (–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –ì–ú)`;
        } else {
            resMsg = "–£–≤—ã, –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–ø–∞–ª–æ.";
        }
        
        document.getElementById('roulette-result').innerText = resMsg;
        addLog(`–†–£–õ–ï–¢–ö–ê: ${resMsg}`, currentUser);
    }, 4100);
}

// OPTIMIZED LOGS RENDERING (–õ–æ–≥–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–∞ –∂–µ, —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –±—ã—Å—Ç—Ä–µ–µ)
function loadLogs() {
    if (userRole !== 'admin' && userRole !== 'owner') return;
    db.ref('logs').limitToLast(100).on('value', s => {
        const list = document.getElementById('logs-list');
        // OPTIMIZATION: Build string once
        let html = [];
        Object.values(s.val() || {}).reverse().forEach(l => {
            html.push(`<div style="padding:8px; border-bottom:1px solid var(--border);">
                <b style="color:var(--primary)">${l.action}</b><br>üë§ ${l.target}<br>üîß ${l.by}<br>üïí ${l.time}
            </div>`);
        });
        list.innerHTML = html.join('');
    });
}

window.onload = () => {
    const savedUser = localStorage.getItem('mod_user');
    if(savedUser) {
        if (savedUser === OWNER) {
             loginSuccess(savedUser, 'owner');
        } else {
            db.ref('users/' + savedUser).once('value', s => { 
                const d = s.val();
                if(s.exists()) {
                    loginSuccess(savedUser, d.role); 
                } else {
                    localStorage.clear();
                }
            });
        }
    }
};
</script>
</body>
</html>
